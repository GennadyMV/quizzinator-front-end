var QuizApp=angular.module("QuizApp",[]);QuizApp.service("AnswerFormatter",["$sce",function(a){function b(a){return{question:a.question,value:a.value}}var c={},d=function(a,b){return{question:a.question,value:"",item_type:b}},e={open_question:function(a){return d(a,"open_question")},multiple_choice_question:function(a){var b=d(a,"multiple_choice_question");return b.options=a.options,b},checkbox_question:function(a){var b=d(a,"checkbox_question");return b.checkboxes=$.map(a.checkboxes,function(a){return{title:a.title,value:!1}}),b},text_container:function(b){var c=d(b,"text_container");return c.content=a.trustAsHtml(b.content),delete c.value,c}},f={open_question:function(a){return b(a)},multiple_choice_question:function(a){return b(a)},checkbox_question:function(a){var c=b(a),d=$.grep(a.checkboxes,function(a){return a.value});return c.value=$.map(d,function(a){return a.title}),c}};return c.input=function(a){var b={title:a.title,id:a.id,items:[]},c=JSON.parse(a.items);return c.forEach(function(a){"function"==typeof e[a.item_type]&&b.items.push(e[a.item_type](a))}),b},c.output=function(a){var b=[];return a.items.forEach(function(a){"function"==typeof f[a.item_type]&&b.push(f[a.item_type](a))}),b},c}]),QuizApp.service("API",["$http","AnswerFormatter",function(a,b){var c={},d="http://localhost:8080";return c.get_quiz=function(c){a({method:"GET",url:d+"/quiz/"+c.id}).success(function(a){c.success(b.input(a))}).error(function(){c.error()})},c.answer_quiz=function(c){a({method:"POST",url:d+"/quiz/"+c.quiz.id+"/answer",dataType:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify({answer:JSON.stringify(b.output(c.quiz)),user:c.user,ip:"192.168.0.0"})}).success(function(a){a.forEach(function(a){a.answer=JSON.parse(a.answer),a.selected=!1}),c.success(a)}).error(function(){c.error()})},c.send_peer_review=function(b){a({method:"POST",url:d+"/quiz/"+b.quiz.id+"/answer/"+b.review.id+"/review",dataType:"json",headers:{"Content-Type":"application/json"},data:JSON.stringify({reviewer:b.reviewer,review:b.review.content})}).success(function(){b.success()}).error(function(){b.error()})},c}]),QuizApp.service("Authentication",function(){function a(a,b){$.jStorage.set(a,b),$.cookie(a,b)}function b(a){return $.cookie(a)||$.jStorage.get(a)}var c={};return c.log_user=function(b){a("quiz_username",b)},c.get_user=function(){return b("quiz_username")},c}),QuizApp.directive("quiz",function(){return{link:function(a,b){$(b).addClass("quiz-panel quiz-container")}}}),QuizApp.controller("MainController",["$scope","Authentication",function(a,b){a.username=b.get_user()}]),QuizApp.controller("QuizController",["$scope","Authentication","API",function(a,b,c){a.username=a.$parent.username,a.init=function(b){a.quiz_id=b,a.username?c.get_quiz({id:a.quiz_id,success:function(b){a.quiz=b,a.view="js/views/quiz_form.html"},error:function(){alert("fail")}}):a.view="js/views/login.html"},a.widget_view=function(a){return"js/views/widgets/"+a+".html"},a.toggle_username_form=function(){a.show_username_form=!a.show_username_form},a.change_username=function(){b.log_user(a.new_username),a.username=a.new_username,a.$parent.username=a.new_username,a.new_username=""},a.send_answer=function(){c.answer_quiz({quiz:a.quiz,user:b.get_user(),success:function(b){b&&0!=b.length?(a.peer_reviews=b,a.view="js/views/peer_review_form.html",a.peer_review_content=""):a.view="js/views/answered.html"},error:function(){alert("fail")}})},a.login=function(){a.$parent.username=a.username,b.log_user(a.username),c.get_quiz({id:a.quiz_id,success:function(b){a.quiz=b,a.view="js/views/quiz_form.html"},error:function(){alert("fail")}})},a.choose_review=function(b){a.peer_reviews.forEach(function(a){a.selected=!1}),b.selected=!0},a.send_peer_review=function(b){var d=$.grep(a.peer_reviews,function(a){return a.selected})[0];alert(a.quiz.id),c.send_peer_review({reviewer:a.username,quiz:a.quiz,review:{id:d.id,content:b},success:function(){alert("ok")},error:function(){alert("fail")}})},a.$parent.$watch("username",function(){a.username=a.$parent.username,"js/views/login.html"==a.view&&a.username&&c.get_quiz({id:a.quiz_id,success:function(b){a.quiz=b,a.view="js/views/quiz_form.html"},error:function(){alert("fail")}})})}]);